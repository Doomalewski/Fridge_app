@model Fridge_app.Models.User
@using System.Linq
@using System.Globalization

@{
    ViewData["Title"] = "Twoja lodówka";
    var alphabet = Enumerable.Range(0, 26).Select(i => ((char)('A' + i)).ToString());
    var productLetters = Model.Fridge
        .Where(p => !string.IsNullOrWhiteSpace(p.Product?.Name))
        .Select(p => p.Product.Name.Trim()[0].ToString().ToUpper(CultureInfo.InvariantCulture))
        .Distinct()
        .ToHashSet();
}
<link rel="stylesheet" href="~/css/fridge.css" />
<div class="home-header mb-4 d-flex justify-content-between align-items-center header-actions">
    <div class="welcome-box">
        <i class="welcome-icon bi bi-box-seam"></i>
        <div>
            <h2 class="welcome-title">Witaj, Oto twoja lodówka.</h2>
            <p class="welcome-subtitle">Dodawaj i zarządzaj produktami do woli.</p>
        </div>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productSearchModal">
            <i class="bi bi-plus-circle"></i> Dodaj produkt
        </button>
        <a href="javascript:history.back()" class="back-link">
            <i class="bi bi-arrow-left"></i> Powrót
        </a>
    </div>
</div>

<div class="alphabet-filter mb-3">
    <div class="alphabet-row">
        <button type="button" class="alphabet-letter active" data-letter="">Wszystkie</button>
        @foreach (var letter in alphabet)
        {
            var hasProducts = productLetters.Contains(letter);
            <button type="button"
                    class="alphabet-letter @(hasProducts ? string.Empty : "disabled")"
                    data-letter="@letter"
                    @(hasProducts ? null : "disabled")>
                @letter
            </button>
        }
    </div>
</div>

<div class="fridge-layout">
    <aside class="filters-panel">
        <div class="filter-header d-flex align-items-center gap-2">
            <i class="bi bi-funnel"></i>
            <div>
                <div class="filter-title">Filtry ważności</div>
                <small class="text-muted">Zawęż widok po dacie</small>
            </div>
        </div>
        <div class="filter-body mt-3">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="expiryFilter" id="filterAll" value="all" checked>
                <label class="form-check-label" for="filterAll">Wszystkie produkty</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="expiryFilter" id="filterExpired" value="expired">
                <label class="form-check-label" for="filterExpired">Przeterminowane</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="expiryFilter" id="filter3Days" value="3days">
                <label class="form-check-label" for="filter3Days">Kończy się &le; 3 dni</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="expiryFilter" id="filter7Days" value="7days">
                <label class="form-check-label" for="filter7Days">Kończy się &le; 7 dni</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="expiryFilter" id="filterFresh" value="fresh">
                <label class="form-check-label" for="filterFresh">Świeże (> 7 dni)</label>
            </div>
        </div>
    </aside>

    <div class="home-wrapper flex-grow-1">
        <div class="dashboard-grid">
            @foreach (var item in Model.Fridge.OrderBy(p => p.Product.Name))
            {
                // Oblicz klasę koloru kropki na podstawie daty ważności
                var daysLeft = (item.ExpirationDate - DateTime.Now).TotalDays;
                var freshnessClass = daysLeft switch
                {
                    > 5 => "fresh",       // zielony
                    > 2 => "warning",     // żółty
                    > 0 => "soon",        // pomarańczowy
                    _ => "expired"        // czerwony
                };
                var letter = string.Empty;
                if (!string.IsNullOrWhiteSpace(item.Product?.Name))
                {
                    var trimmed = item.Product.Name.Trim();
                    letter = char.ToUpperInvariant(trimmed[0]).ToString();
                }

                <div class="dashboard-card visible" data-days-left="@daysLeft.ToString("F2", CultureInfo.InvariantCulture)" data-freshness="@freshnessClass" data-letter="@letter">
                    <div class="card-content">
                        <div class="product-header">
                            <h3 class="product-name">@item.Product.Name</h3>
                            <span class="freshness-dot @freshnessClass"
                                  title="Ważny do: @(item.ExpirationDate != null ? item.ExpirationDate.ToLocalTime().ToString("dd/MM/yyyy") : "Brak daty ważności")">
                            </span>
                        </div>

                        <p>Ilość: <strong>@item.Quantity @item.Product.Unit</strong></p>
                        <p>Ważny do: <strong>@item.ExpirationDate.ToLocalTime().ToString("dd/MM/yyyy")</strong></p>
                    </div>
                    <div class="mt-auto d-flex justify-content-between pt-3">
                        <button class="btn btn-outline-dark btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#editModal"
                                data-id="@item.Id"
                                data-quantity="@item.Quantity"
                                data-unit="@item.Product.Unit">
                            Edytuj
                        </button>
                        <button class="btn btn-danger btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal"
                                data-id="@item.Id"
                                data-name="@item.Product.Name">
                            Usuń
                        </button>
                    </div>
                </div>
            }
        </div>

        <form asp-controller="User" asp-action="GenerateMeal" method="post" class="mt-4 text-center" id="generateMealForm">
            <button type="button" class="btn btn-primary" style="margin-top: 2rem; padding: 0.8rem 2rem;" data-bs-toggle="modal" data-bs-target="#generateMealModal">
                <i class="fas fa-magic"></i> Wygeneruj przepis
            </button>
        </form>
    </div>
</div>

<!-- Modal edycji -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-3 shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj produkt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-controller="Fridge" asp-action="UpdateProduct" method="post">
                <div class="modal-body">
                    <input type="hidden" name="Id" id="editProductId">
                    <div class="mb-3">
                        <label class="form-label">Nowa ilość</label>
                        <input type="number" step="0.01" class="form-control" name="NewQuantity" required>
                        <span class="text-muted" id="unitDisplay"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal usuwania -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-3 shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title">Potwierdź usunięcie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-controller="Fridge" asp-action="DeleteProduct" method="post">
                <div class="modal-body">
                    <input type="hidden" name="id" id="deleteProductId">
                    <p>Czy na pewno chcesz usunąć produkt <span id="productNameDisplay"></span>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-danger">Usuń</button>
                </div>
            </form>
        </div>
    </div>
</div>

@await Html.PartialAsync("_AddProductModals")

<!-- Modal generowania przepisu z preferencjami -->
<div class="modal fade" id="generateMealModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-3 shadow-sm">
    <div class="modal-header">
          <h5 class="modal-title">Preferencje generowania przepisu</h5>
     <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
<form asp-controller="User" asp-action="GenerateMeal" method="post">
                <div class="modal-body">
      <div class="mb-4">
         <h6 class="mb-3">Typ posiłku</h6>
            <div class="form-check">
     <input class="form-check-input" type="radio" name="MealType" id="mealBreakfast" value="Śniadanie">
             <label class="form-check-label" for="mealBreakfast">Śniadanie</label>
          </div>
       <div class="form-check">
              <input class="form-check-input" type="radio" name="MealType" id="mealLunch" value="Obiad">
            <label class="form-check-label" for="mealLunch">Obiad</label>
     </div>
     <div class="form-check">
        <input class="form-check-input" type="radio" name="MealType" id="mealDinner" value="Kolacja">
          <label class="form-check-label" for="mealDinner">Kolacja</label>
           </div>
                <div class="form-check">
        <input class="form-check-input" type="radio" name="MealType" id="mealSnack" value="Przekąska">
   <label class="form-check-label" for="mealSnack">Przekąska</label>
       </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="MealType" id="mealOther" value="Inne">
             <label class="form-check-label" for="mealOther">Inne</label>
      </div>
     </div>

           <div class="mb-4">
              <h6 class="mb-3">Poziom trudności</h6>
         <div class="form-check">
    <input class="form-check-input" type="radio" name="Difficulty" id="diffEasy" value="Easy">
        <label class="form-check-label" for="diffEasy">Łatwy</label>
  </div>
     <div class="form-check">
          <input class="form-check-input" type="radio" name="Difficulty" id="diffMedium" value="Medium">
                 <label class="form-check-label" for="diffMedium">Średni</label>
       </div>
          <div class="form-check">
             <input class="form-check-input" type="radio" name="Difficulty" id="diffHard" value="Hard">
   <label class="form-check-label" for="diffHard">Trudny</label>
  </div>
            </div>

     <div class="mb-4">
               <h6 class="mb-3">Czas przygotowania</h6>
   <div class="form-check">
    <input class="form-check-input" type="radio" name="PrepTime" id="timeQuick" value="Szybkie (do 15 minut)">
         <label class="form-check-label" for="timeQuick">Szybkie (do 15 minut)</label>
         </div>
         <div class="form-check">
         <input class="form-check-input" type="radio" name="PrepTime" id="timeMedium" value="Średnie (15-45 minut)">
    <label class="form-check-label" for="timeMedium">Średnie (15-45 minut)</label>
        </div>
      <div class="form-check">
 <input class="form-check-input" type="radio" name="PrepTime" id="timeLong" value="Długie (ponad 45 minut)">
      <label class="form-check-label" for="timeLong">Długie (ponad 45 minut)</label>
 </div>
    </div>

   <div class="mb-4">
   <label for="cuisineType" class="form-label">Rodzaj kuchni (opcjonalnie)</label>
          <select class="form-select" id="cuisineType" name="CuisineType">
        <option value="">Brak preferencji</option>
          <option value="Włoska">Włoska</option>
    <option value="Azjatycka">Azjatycka</option>
       <option value="Śródziemnomorska">Śródziemnomorska</option>
       <option value="Meksykańska">Meksykańska</option>
        <option value="Indyjska">Indyjska</option>
 <option value="Polska">Polska</option>
    <option value="Francuska">Francuska</option>
           <option value="Niemiecka">Niemiecka</option>
<option value="Orientalna">Orientalna</option>
         </select>
       </div>

             <div class="mb-4">
      <h6 class="mb-3">Preferencje żywieniowe</h6>
     <div class="form-check">
                <input class="form-check-input" type="checkbox" id="isVegetarian" name="IsVegetarian">
      <label class="form-check-label" for="isVegetarian">Wegetariańskie</label>
        </div>
 <div class="form-check">
       <input class="form-check-input" type="checkbox" id="isVegan" name="IsVegan">
        <label class="form-check-label" for="isVegan">Wegańskie</label>
   </div>
    </div>

          <div class="mb-4">
        <label for="additionalPreferences" class="form-label">Dodatkowe preferencje (opcjonalnie)</label>
          <textarea class="form-control" id="additionalPreferences" name="AdditionalPreferences" rows="3" placeholder="Np. bez orzechów, bez mleka, bez glutenu..."></textarea>
    </div>

   <div class="mb-4">
        <h6 class="mb-3">Język przepisu</h6>
  <div class="form-check">
   <input class="form-check-input" type="radio" name="Language" id="langPolish" value="pl" checked>
        <label class="form-check-label" for="langPolish">🇵🇱 Polski</label>
     </div>
   <div class="form-check">
        <input class="form-check-input" type="radio" name="Language" id="langEnglish" value="en">
      <label class="form-check-label" for="langEnglish">🇬🇧 English</label>
     </div>
    </div>
           </div>
     <div class="modal-footer">
         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-primary">
             <i class="fas fa-magic"></i> Wygeneruj przepis
          </button>
     </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Inicjalizacja modalów
        $('#editModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const modal = $(this);
            modal.find('#editProductId').val(button.data('id'));
            modal.find('input[name="NewQuantity"]').val(button.data('quantity'));
            modal.find('#unitDisplay').text(button.data('unit'));
        });

        $('#deleteModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const modal = $(this);
            modal.find('#deleteProductId').val(button.data('id'));
            modal.find('#productNameDisplay').text(button.data('name'));
        });

        let selectedLetter = '';

        function matchesExpiry(card, selectedExpiry) {
            const daysLeft = parseFloat(card.dataset.daysLeft);
            const freshness = card.dataset.freshness;

            switch (selectedExpiry) {
                case 'expired':
                    return freshness === 'expired' || daysLeft < 0;
                case '3days':
                    return daysLeft <= 3 && daysLeft >= 0;
                case '7days':
                    return daysLeft <= 7 && daysLeft >= 0;
                case 'fresh':
                    return daysLeft > 7;
                default:
                    return true;
            }
        }

        function updateAlphabetButtons(selectedExpiry) {
            const letterButtons = document.querySelectorAll('.alphabet-letter');
            const availableLetters = new Set();

            document.querySelectorAll('.dashboard-card').forEach(card => {
                if (matchesExpiry(card, selectedExpiry)) {
                    const letter = (card.dataset.letter || '').trim();
                    if (letter) {
                        availableLetters.add(letter);
                    }
                }
            });

            let shouldResetSelection = false;
            letterButtons.forEach(button => {
                const letter = button.dataset.letter || '';
                if (letter === '') {
                    button.disabled = false;
                    button.classList.remove('disabled');
                    return;
                }

                const enabled = availableLetters.has(letter);
                button.disabled = !enabled;
                button.classList.toggle('disabled', !enabled);

                if (!enabled && selectedLetter === letter) {
                    shouldResetSelection = true;
                }
            });

            if (shouldResetSelection) {
                selectedLetter = '';
                letterButtons.forEach(btn => btn.classList.remove('active'));
                const allBtn = document.querySelector('.alphabet-letter[data-letter=""]');
                if (allBtn) {
                    allBtn.classList.add('active');
                }
            }
        }

        function applyFilters() {
            const selectedExpiry = document.querySelector('input[name="expiryFilter"]:checked')?.value || 'all';

            updateAlphabetButtons(selectedExpiry);

            document.querySelectorAll('.dashboard-card').forEach(card => {
                const letter = card.dataset.letter || '';
                const matches = matchesExpiry(card, selectedExpiry);
                const matchesLetter = !selectedLetter || letter === selectedLetter;

                const isVisible = matches && matchesLetter;
                card.style.display = isVisible ? '' : 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="expiryFilter"]').forEach(radio => {
                radio.addEventListener('change', applyFilters);
            });

            document.querySelectorAll('.alphabet-letter').forEach(button => {
                if (button.disabled) return;
                button.addEventListener('click', () => {
                    if (button.disabled) return;
                    selectedLetter = button.dataset.letter || '';
                    document.querySelectorAll('.alphabet-letter').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    applyFilters();
                });
            });

            applyFilters();
        });

        // Obsługa powiadomień
        @if (TempData["Success"] != null)
        {
                <text>
                    toastr.success('@TempData["Success"]');
                </text>
        }
        @if (TempData["Error"] != null)
        {
                <text>
                    toastr.error('@TempData["Error"]');
                </text>
        }
    </script>

    <script>
        // Zaktualizowana funkcja wyszukiwania (case-insensitive)
        function searchProducts() {
            const searchTerm = document.getElementById('searchTerm').value.toLowerCase();
            const category = document.getElementById('searchCategory').value;

            fetch(`/Home/SearchProducts?searchTerm=${encodeURIComponent(searchTerm)}&category=${category}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('searchResults').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('searchResults').innerHTML = '<div class="col-12"><div class="alert alert-danger">Błąd podczas wyszukiwania</div></div>';
                });
        }

        // Funkcja wyboru produktu
        function selectProduct(productId, productName) {
            document.getElementById('selectedProductId').value = productId;
            document.getElementById('selectedProductName').value = productName;

            // Zamknięcie modala wyszukiwania
            const searchModal = bootstrap.Modal.getInstance(document.getElementById('productSearchModal'));
            searchModal.hide();

            // Otwarcie modala formularza
            const addModal = new bootstrap.Modal(document.getElementById('addProductFormModal'));
            addModal.show();
        }

        // Obsługa formularza
        document.getElementById('addProductForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = {
                ProductId: parseInt(document.getElementById('selectedProductId').value),
                Quantity: parseFloat(document.getElementById('quantity').value),
                ExpirationDate: document.getElementById('expirationDate').value || null
            };

            try {
                const response = await fetch('/Home/AddProduct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    location.reload(); // Odśwież stronę po udanym zapisie
                } else {
                    alert('Wystąpił błąd podczas zapisywania');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Błąd połączenia z serwerem');
            }
        });
    </script>
}
