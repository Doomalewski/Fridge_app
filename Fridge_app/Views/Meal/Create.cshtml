@model Fridge_app.Models.ViewModels.MealCreateViewModel
@{
    var availableProducts = Model.AvailableProducts ?? new List<Product>();
}
<link rel="stylesheet" href="~/css/home.css" />

<div class="home-wrapper">
    <div class="home-header">
        <div class="welcome-box">
            <div class="welcome-icon">
                <i class="bi bi-journal-plus"></i>
            </div>
            <div>
                <h1 class="welcome-title">Dodaj nowy posiłek</h1>
                <p class="welcome-subtitle">Twórz posiłki i zarządzaj składnikami w swojej lodówce ❄️</p>
            </div>
        </div>
    </div>

    <form asp-action="Create">
        <div class="dashboard-grid">
            <!-- Informacje o posiłku -->
            <div class="dashboard-card animate">
                <div class="card-content">
                    <h3>Informacje o posiłku</h3>
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label"></label>
                        <input asp-for="Description" class="form-control">
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Category" class="form-label">Kategoria</label>
                        <select asp-for="Category" class="form-select">
                            <option value="">Wybierz kategorię</option>
                            <option value="Śniadanie">Śniadanie</option>
                            <option value="Obiad">Obiad</option>
                            <option value="Kolacja">Kolacja</option>
                            <option value="Przekąska">Przekąska</option>
                            <option value="Deser">Deser</option>
                        </select>
                        <span asp-validation-for="Category" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Przepis i produkty -->
            <div class="dashboard-card animate">
                <div class="card-content">
                    <h3>Przepis i składniki</h3>

                    <div class="mb-3">
                        <label asp-for="Recipe.Difficulty" class="form-label">Trudność</label>
                        <select asp-for="Recipe.Difficulty" class="form-select">
                            <option value="Easy">Łatwy</option>
                            <option value="Średni">Średni</option>
                            <option value="Trudny">Trudny</option>
                        </select>
                    </div>

                    <div class="mt-4">
                        <h5>Składniki</h5>
                        <div id="productsContainer">
                            @for (var i = 0; i < Model.SelectedProducts.Count; i++)
                            {
                                <div class="product-row mb-3">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <select asp-for="SelectedProducts[i].ProductId"
                                                    class="form-select"
                                                    asp-items="@(new SelectList(Model.AvailableProducts ?? new List<Product>(), "Id", "Name"))">
                                                <option value="">Wybierz produkt</option>
                                            </select>
                                        </div>
                                        <div class="col-4">
                                            <input asp-for="SelectedProducts[i].Amount"
                                                   class="form-control"
                                                   placeholder="Ilość">
                                        </div>
                                        <div class="col-2">
                                            <button type="button"
                                                    class="btn btn-danger w-100"
                                                    onclick="removeProduct(this)">
                                                ×
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <button type="button"
                                class="card-link mt-2"
                                onclick="addProduct()">
                            Dodaj składnik
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            <button type="submit" class="card-link">Zapisz posiłek</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const cards = document.querySelectorAll('.animate');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('visible');
                }, index * 150);
            });
        });

        function addProduct() {
            const index = document.querySelectorAll('.product-row').length;
            const template = `
                <div class="product-row mb-3">
                    <div class="row g-2">
                        <div class="col-6">
                            <select name="SelectedProducts[${index}].ProductId"
                                    class="form-select">
                                <option value="">Wybierz produkt</option>
                                @foreach (var product in Model.AvailableProducts)
                                {
                                        <option value="@product.Id">@product.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-4">
                            <input name="SelectedProducts[${index}].Amount"
                                   class="form-control"
                                   placeholder="Ilość">
                        </div>
                        <div class="col-2">
                            <button type="button"
                                    class="btn btn-danger w-100"
                                    onclick="removeProduct(this)">
                                ×
                            </button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('productsContainer').insertAdjacentHTML('beforeend', template);
        }

        function removeProduct(button) {
            button.closest('.product-row').remove();
        }
    </script>
}
