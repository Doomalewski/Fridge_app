@using System.Linq
@using System.Globalization
@using System.Collections.Generic
@model IEnumerable<Fridge_app.Models.Meal>

@{
    ViewData["Title"] = "Moje przepisy";
    var orderedMeals = Model?
        .OrderBy(m => m.Recipe?.Name ?? string.Empty)
        .ToList();
    var alphabet = Enumerable.Range(0, 26).Select(i => ((char)('A' + i)).ToString());
    var mealLetters = orderedMeals?
        .Select(m => m.Recipe?.Name?.Trim())
        .Where(name => !string.IsNullOrWhiteSpace(name))
        .Select(name => char.ToUpperInvariant(name![0]).ToString(CultureInfo.InvariantCulture))
        .Distinct()
        .ToHashSet()
        ?? new HashSet<string>();
    var categories = orderedMeals?
        .Select(m => m.Category)
        .Where(c => !string.IsNullOrWhiteSpace(c))
        .Distinct(StringComparer.CurrentCultureIgnoreCase)
        .OrderBy(c => c)
        .ToList() ?? new List<string>();
    var difficulties = orderedMeals?
        .Select(m => m.Recipe?.Difficulty)
        .Where(d => !string.IsNullOrWhiteSpace(d))
        .Distinct(StringComparer.CurrentCultureIgnoreCase)
        .OrderBy(d => d)
        .ToList() ?? new List<string>();
}

<link rel="stylesheet" href="~/css/home.css" />
<link rel="stylesheet" href="~/css/mykitchen-mymeals.css" />
<style>
    /* Styl paska liter jak w lodówce, bez wp³ywu na resztê widoku */
    .alphabet-filter {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid #d1d1d1;
        border-radius: 0.9rem;
        padding: 0.6rem 0.75rem;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }

    .alphabet-row {
        display: flex;
        flex-wrap: nowrap;
        gap: 0.3rem;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        overflow-x: auto;
    }

    .alphabet-letter {
        border: 1px solid #d1d1d1;
        background: #f8f9fa;
        color: #333;
        border-radius: 0.55rem;
        padding: 0.28rem 0.6rem;
        min-width: 34px;
        flex: 0 0 auto;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
        line-height: 1;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .alphabet-letter:hover {
        background: #e9ecef;
    }

    .alphabet-letter.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .alphabet-letter.disabled,
    .alphabet-letter:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #f5f5f5;
        color: #888;
        pointer-events: none;
    }

    .meals-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 1rem;
        align-items: start;
    }

    @@media (max-width: 992px) {
        .meals-layout {
            grid-template-columns: 1fr;
        }

        .filters-panel {
            position: static;
            max-height: none;
        }
    }

    .filters-panel {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 0.9rem;
        padding: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: calc(var(--navbar-height, 64px) + 1rem);
        width: 100%;
        max-height: calc(100vh - 96px);
        overflow-y: auto;
        z-index: 2;
    }

    .filter-header .filter-title {
        font-weight: 700;
        font-size: 1rem;
        margin: 0;
    }

    .filter-body .form-check {
        margin-bottom: 0.35rem;
    }
</style>

<div class="home-wrapper">
    <div class="home-header">
        <div class="welcome-box">
     <div class="welcome-icon">
<i class="bi bi-book"></i>
  </div>
  <div>
    <h1 class="welcome-title">Moje przepisy</h1>
       <p class="welcome-subtitle">Przejrzyj i zarz¹dzaj swoimi zapisanymi przepisami</p>
        </div>
        </div>
        <div class="header-actions">
            <a href="javascript:history.back()" class="back-link">
                <i class="bi bi-arrow-left"></i> Powrót
            </a>
        </div>
    </div>

    @if (orderedMeals?.Any() == true)
    {
 <div class="alphabet-filter mb-3">
     <div class="alphabet-row">
        <button type="button" class="alphabet-letter active" data-letter="">Wszystkie</button>
        @foreach (var letter in alphabet)
        {
            var hasMeals = mealLetters.Contains(letter);
            <button type="button"
                    class="alphabet-letter @(hasMeals ? string.Empty : "disabled")"
                    data-letter="@letter"
                    @(hasMeals ? null : "disabled")>
                @letter
            </button>
        }
     </div>
 </div>

 <div class="meals-layout">
     <aside class="filters-panel">
         <div class="filter-header d-flex align-items-center gap-2">
             <i class="bi bi-funnel"></i>
             <div>
                 <div class="filter-title">Filtry przepisów</div>
                 <small class="text-muted">Zawê¿ widok jak w lodówce</small>
             </div>
         </div>
         <div class="filter-body mt-3">
             <div class="mb-3">
                 <div class="fw-semibold mb-1">Rodzaj dania</div>
                 <div class="form-check">
                     <input class="form-check-input" type="radio" name="categoryFilter" id="catAll" value="" checked>
                     <label class="form-check-label" for="catAll">Wszystkie</label>
                 </div>
                 @for (var i = 0; i < categories.Count; i++)
                 {
                     var c = categories[i];
                     var id = $"cat{i}";
                     <div class="form-check">
                         <input class="form-check-input" type="radio" name="categoryFilter" id="@id" value="@c">
                         <label class="form-check-label" for="@id">@c</label>
                     </div>
                 }
             </div>

             <div class="mb-3">
                 <div class="fw-semibold mb-1">Poziom trudnoœci</div>
                 <div class="form-check">
                     <input class="form-check-input" type="radio" name="difficultyFilter" id="diffAll" value="" checked>
                     <label class="form-check-label" for="diffAll">Dowolny</label>
                 </div>
                 @for (var i = 0; i < difficulties.Count; i++)
                 {
                     var d = difficulties[i];
                     var id = $"diff{i}";
                     <div class="form-check">
                         <input class="form-check-input" type="radio" name="difficultyFilter" id="@id" value="@d">
                         <label class="form-check-label" for="@id">@d</label>
                     </div>
                 }
             </div>

             <div class="mb-1">
                 <div class="fw-semibold mb-1">Czas przygotowania</div>
                 <div class="form-check">
                     <input class="form-check-input" type="radio" name="timeFilter" id="timeAll" value="" checked>
                     <label class="form-check-label" for="timeAll">Dowolny</label>
                 </div>
                 <div class="form-check">
                     <input class="form-check-input" type="radio" name="timeFilter" id="time15" value="15">
                     <label class="form-check-label" for="time15">Do 15 min</label>
                 </div>
                 <div class="form-check">
                     <input class="form-check-input" type="radio" name="timeFilter" id="time30" value="30">
                     <label class="form-check-label" for="time30">Do 30 min</label>
                 </div>
                 <div class="form-check">
                     <input class="form-check-input" type="radio" name="timeFilter" id="time45" value="45">
                     <label class="form-check-label" for="time45">Do 45 min</label>
                 </div>
                 <div class="form-check">
                     <input class="form-check-input" type="radio" name="timeFilter" id="time45plus" value="45+">
                     <label class="form-check-label" for="time45plus">Ponad 45 min</label>
                 </div>
             </div>
         </div>
     </aside>

     <div class="dashboard-grid meals-grid">
          @foreach (var meal in orderedMeals)
       {
           var letter = string.Empty;
           var recipeName = meal.Recipe?.Name?.Trim();
           if (!string.IsNullOrWhiteSpace(recipeName))
           {
               letter = char.ToUpperInvariant(recipeName![0]).ToString(CultureInfo.InvariantCulture);
           }
           var totalTime = meal.Recipe?.Steps?.Sum(s => s.StepTime ?? 0) ?? 0;
 <div class="dashboard-card dashboard-card-meal animate" data-letter="@letter" data-category="@meal.Category" data-difficulty="@meal.Recipe?.Difficulty" data-time="@totalTime">
      <div class="card-icon bg-info-light">
          <i class="bi bi-bookmark"></i>
</div>
     <div class="card-content">
    <h3>@meal.Recipe.Name</h3>
   <p>@meal.Description</p>
           
      <div class="meal-badges mb-2">
    <span class="badge bg-info">@meal.Category</span>
  <span class="badge bg-warning text-dark">@meal.Recipe.Difficulty</span>
   </div>

   @if (meal.Tags?.Any() == true)
{
<div class="meal-tags mb-2">
    @foreach (var tag in meal.Tags.Take(2))
       {
  <span class="badge bg-secondary">@tag.Name</span>
          }
      @if (meal.Tags.Count > 2)
   {
     <span class="badge bg-secondary">+@(meal.Tags.Count - 2)</span>
    }
            </div>
    }

           <div class="meal-meta mt-3">
 <div class="meta-item">
 <i class="bi bi-basket"></i>

<small>@meal.Recipe.Ingridients?.DistinctBy(i => i.ProductId).Count() sk³adnik(ów)</small>
      </div>
  <div class="meta-item">
<i class="bi bi-clock"></i>
        <small>@(meal.Recipe.Steps?.Sum(s => s.StepTime ?? 0)) min</small>
       </div>
      <div class="meta-item">
   <i class="bi bi-calendar"></i>
 <small>@meal.Recipe.CreatedAt.ToShortDateString()</small>
       </div>
        </div>
      </div>
 <div style="display: flex; gap: 8px;">
       <a asp-action="MealDetails" asp-route-id="@meal.Id" class="card-link" style="flex: 1;">
   <i class="bi bi-eye"></i> Szczegó³y
     </a>
    <form asp-action="DeleteMeal" asp-route-id="@meal.Id" method="post" style="flex-shrink: 0; display: flex;" onsubmit="return confirm('Czy na pewno chcesz usun¹æ ten przepis?');">
      <button type="submit" class="card-link" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; background-color: #dc3545; border: none; cursor: pointer; border-radius: 4px;">
   <i class="bi bi-trash"></i>
   </button>
    </form>
      </div>
  </div>
       }
     </div>
 </div>
  }
 else
    {
  <div class="empty-state">
     <div class="empty-icon">
  <i class="bi bi-inbox"></i>
      </div>
   <h3>Nie masz jeszcze zapisanych przepisów</h3>
            <p>Wygeneruj swój pierwszy przepis na podstawie produktów z lodówki!</p>
        <form asp-action="GenerateMeal" method="post" class="mt-4">
 <button type="submit" class="btn btn-primary btn-lg">
     <i class="bi bi-magic"></i> Wygeneruj przepis
    </button>
   </form>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const cards = document.querySelectorAll('.dashboard-card.animate');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('visible');
                }, index * 150);
            });

            let selectedLetter = '';
            const letterButtons = document.querySelectorAll('.alphabet-letter');
            const allLetterButton = document.querySelector('.alphabet-letter[data-letter=""]');

            const getSelected = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || '';

            const matchesOtherFilters = (card, category, difficulty, time) => {
                const cardCategory = (card.dataset.category || '').toLowerCase();
                const cardDifficulty = (card.dataset.difficulty || '').toLowerCase();
                const totalTime = parseInt(card.dataset.time || '0', 10);

                if (category && cardCategory !== category.toLowerCase()) return false;
                if (difficulty && cardDifficulty !== difficulty.toLowerCase()) return false;

                if (time) {
                    switch (time) {
                        case '15':
                            if (totalTime > 15) return false;
                            break;
                        case '30':
                            if (totalTime > 30) return false;
                            break;
                        case '45':
                            if (totalTime > 45) return false;
                            break;
                        case '45+':
                            if (totalTime <= 45) return false;
                            break;
                    }
                }

                return true;
            };

            const updateLetterButtons = (category, difficulty, time) => {
                const availableLetters = new Set();

                cards.forEach(card => {
                    if (matchesOtherFilters(card, category, difficulty, time)) {
                        const letter = (card.dataset.letter || '').trim();
                        if (letter) {
                            availableLetters.add(letter);
                        }
                    }
                });

                let shouldReset = false;
                letterButtons.forEach(button => {
                    const letter = button.dataset.letter || '';
                    if (letter === '') {
                        button.disabled = false;
                        button.classList.remove('disabled');
                        return;
                    }

                    const enabled = availableLetters.has(letter);
                    button.disabled = !enabled;
                    button.classList.toggle('disabled', !enabled);

                    if (!enabled && selectedLetter === letter) {
                        shouldReset = true;
                    }
                });

                if (shouldReset) {
                    selectedLetter = '';
                    letterButtons.forEach(btn => btn.classList.remove('active'));
                    if (allLetterButton) {
                        allLetterButton.classList.add('active');
                    }
                }
            };

            const applyMealFilters = () => {
                const selectedCategory = getSelected('categoryFilter');
                const selectedDifficulty = getSelected('difficultyFilter');
                const selectedTime = getSelected('timeFilter');

                updateLetterButtons(selectedCategory, selectedDifficulty, selectedTime);

                cards.forEach(card => {
                    const letter = card.dataset.letter || '';
                    const matchesFilters = matchesOtherFilters(card, selectedCategory, selectedDifficulty, selectedTime);
                    const matchesLetter = !selectedLetter || letter === selectedLetter;

                    const isVisible = matchesFilters && matchesLetter;
                    card.style.display = isVisible ? '' : 'none';
                });
            };

            letterButtons.forEach(button => {
                if (button.disabled) return;
                button.addEventListener('click', () => {
                    if (button.disabled) return;
                    selectedLetter = button.dataset.letter || '';
                    letterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    applyMealFilters();
                });
            });

            document.querySelectorAll('input[name="categoryFilter"], input[name="difficultyFilter"], input[name="timeFilter"]').forEach(radio => {
                radio.addEventListener('change', applyMealFilters);
            });

            applyMealFilters();
  });
    </script>
}
