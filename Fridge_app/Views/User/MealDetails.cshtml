@using System.Security.Claims
@model Fridge_app.Models.Meal

@{
  ViewData["Title"] = Model.Recipe.Name;
    var currentUserId = 0;
    if (User.Identity?.IsAuthenticated == true && int.TryParse(User.FindFirstValue(ClaimTypes.NameIdentifier), out int userId))
    {
 currentUserId = userId;
    }
    var isOwner = currentUserId > 0 && currentUserId == Model.UserId;
}

<link rel="stylesheet" href="~/css/mealprev.css" />

<div class="meal-preview-wrapper">
    <div class="meal-header">
    <h1 class="meal-title">@Model.Recipe.Name</h1>
        <p class="meal-subtitle">@Model.Description</p>
        <div style="margin-top: 1.5rem;">
<a href="javascript:history.back()" style="display: inline-block; padding: 0.6rem 1.5rem; background-color: #6c757d; color: #fff; border-radius: 0.8rem; text-decoration: none; font-weight: 500; transition: all 0.3s ease;">
      <i class="bi bi-arrow-left"></i> Powrót
      </a>
        </div>
    </div>

    <div class="meal-grid">
    <!-- Informacje o posi³ku -->
        <div class="meal-card animate">
          <h3>Informacje o posi³ku</h3>
            <p><strong>Kategoria:</strong> @Model.Category</p>
   <p><strong>Poziom trudnoœci:</strong> @Model.Recipe.Difficulty</p>
            <p><strong>Data utworzenia:</strong> @Model.Recipe.CreatedAt.ToShortDateString()</p>
   <p><strong>Ca³kowity czas przygotowania:</strong> @(Model.Recipe.Steps?.Sum(s => s.StepTime ?? 0) ?? 0) min</p>
       @if (Model.Tags?.Any() == true)
       {
   <p>
  <strong>Tagi:</strong><br />
 @foreach (var tag in Model.Tags)
 {
    <span style="display: inline-block; background: #e0e0e0; color: #555; padding: 0.3rem 0.8rem; border-radius: 0.8rem; font-size: 0.9rem; margin: 0.2rem 0.2rem 0.2rem 0;">@tag.Name</span>
  }
          </p>
 }
        </div>

        <!-- Sk³adniki -->
    <div class="meal-card animate">
       <h3>Sk³adniki</h3>
     @if (Model.Recipe.Ingridients?.Any() == true)
 {
         <ul class="ingredient-list">
      @foreach (var ing in Model.Recipe.Ingridients.DistinctBy(i => i.Product.Id))
  {
            <li>@ing.Product.Name — @ing.Amount g</li>
          }
  </ul>
  }
       else
         {
    <p class="text-muted">Brak sk³adników do wyœwietlenia.</p>
         }
 </div>

 <!-- Kroki przygotowania -->
        <div class="meal-card animate">
   <h3>Kroki przygotowania</h3>
  @if (Model.Recipe.Steps?.Any() == true)
        {
       <ol class="step-list">
          @foreach (var step in Model.Recipe.Steps.OrderBy(s => s.StepNumber))
         {
  <li>
             <p style="margin: 0;">@step.Instruction</p>
  @if (step.StepTime.HasValue)
    {
    <small>@step.StepTime min</small>
  }
              </li>
       }
      </ol>
       }
   else
       {
          <p class="text-muted">Brak kroków przygotowania.</p>
            }
        </div>

    <!-- Narzêdzia kuchenne -->
        <div class="meal-card animate">
       <h3>Narzêdzia kuchenne</h3>
    @if (Model.Recipe.CookingTools?.Any() == true)
        {
    <div class="tools-list">
    @foreach (var tool in Model.Recipe.CookingTools)
       {
 <span>@tool.Name</span>
   }
       </div>
   }
   else
  {
      <p class="text-muted">Brak wymaganych narzêdzi.</p>
  }
        </div>
    </div>

    @if (isOwner)
    {
    <div class="text-center mt-4" style="margin-top: 2rem;">
        <form asp-action="DeleteMeal" asp-route-id="@Model.Id" method="post" style="display:inline;" onsubmit="return confirm('Czy na pewno chcesz usun¹æ ten przepis? Tej operacji nie bêdzie mo¿na cofn¹æ.');">
  <button type="submit" class="meal-btn" style="background-color: #dc3545;">
           <i class="bi bi-trash"></i> Usuñ przepis
            </button>
        </form>
    </div>
}
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const cards = document.querySelectorAll('.animate');
        cards.forEach((card, index) => {
setTimeout(() => {
    card.classList.add('visible'); // animacja wjazdu + animacja linii
   }, index * 150);
   });
   });
 </script>
}
