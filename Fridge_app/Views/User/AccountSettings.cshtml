@model Fridge_app.Models.ViewModels.AccountSettingsViewModel

@{
    ViewData["Title"] = "Ustawienia konta";
}

<link rel="stylesheet" href="~/css/home.css" />
<link rel="stylesheet" href="~/css/mykitchen-mymeals.css" />

<div class="home-wrapper">
    <div class="home-header">
        <div class="welcome-box">
            <div class="welcome-icon">
                <i class="bi bi-gear"></i>
            </div>
            <div>
                <h1 class="welcome-title">Ustawienia konta</h1>
                <p class="welcome-subtitle">Zarz¹dzaj swoim kontem i preferencjami</p>
            </div>
        </div>
        <div class="header-actions">
            <a href="javascript:history.back()" class="back-link">
                <i class="bi bi-arrow-left"></i> Powrót
            </a>
        </div>
    </div>

    <div class="settings-content">
        <form asp-action="AccountSettings" method="post" id="settingsForm">
            
            <!-- 1. STATYSTYKI ZDROWOTNE -->
            <div class="dashboard-card visible mb-4">
                <div class="card-icon bg-info-light">
                    <i class="bi bi-activity"></i>
                </div>
                <div class="card-content">
                    <h3>Statystyki zdrowotne</h3>
                    <p class="text-muted mb-3">Podaj swoje dane fizyczne</p>
                    
                    <!-- Wiek - suwak -->
                    <div class="form-group">
                        <label for="Age" class="form-label">
                            Wiek: <span id="ageValue">@(Model.Age ?? 25)</span> lat *
                        </label>
                        <input type="range" class="form-range" id="Age" name="Age" 
                               asp-for="Age" min="1" max="120" value="@(Model.Age ?? 25)" 
                               oninput="updateSliderValue('Age', 'ageValue', ' lat')" required />
                        <div class="range-labels">
                            <small>1</small>
                            <small>120</small>
                        </div>
                        <span asp-validation-for="Age" class="text-danger"></span>
                    </div>

                    <!-- P³eæ -->
                    <div class="form-group">
                        <label for="Sex" class="form-label">P³eæ *</label>
                        <select class="form-select" id="Sex" name="Sex" asp-for="Sex" required>
                            <option value="">-- Wybierz --</option>
                            <option value="Mê¿czyzna">Mê¿czyzna</option>
                            <option value="Kobieta">Kobieta</option>
                            <option value="Inna">Inna</option>
                        </select>
                        <span asp-validation-for="Sex" class="text-danger"></span>
                    </div>

                    <!-- Wzrost - suwak -->
                    <div class="form-group">
                        <label for="Height" class="form-label">
                            Wzrost: <span id="heightValue">@(Model.Height ?? 170)</span> cm *
                        </label>
                        <input type="range" class="form-range" id="Height" name="Height" 
                               asp-for="Height" min="50" max="250" step="0.5" value="@(Model.Height ?? 170)" 
                               oninput="updateSliderValue('Height', 'heightValue', ' cm')" required />
                        <div class="range-labels">
                            <small>50 cm</small>
                            <small>250 cm</small>
                        </div>
                        <span asp-validation-for="Height" class="text-danger"></span>
                    </div>

                    <!-- Waga - suwak -->
                    <div class="form-group">
                        <label for="CurrentWeight" class="form-label">
                            Aktualna waga: <span id="weightValue">@(Model.CurrentWeight ?? 70)</span> kg *
                        </label>
                        <input type="range" class="form-range" id="CurrentWeight" name="CurrentWeight" 
                               asp-for="CurrentWeight" min="20" max="200" step="0.1" value="@(Model.CurrentWeight ?? 70)" 
                               oninput="updateSliderValue('CurrentWeight', 'weightValue', ' kg')" required />
                        <div class="range-labels">
                            <small>20 kg</small>
                            <small>200 kg</small>
                        </div>
                        <span asp-validation-for="CurrentWeight" class="text-danger"></span>
                        <small class="text-muted">Twoja historia wagi zostanie zapisana</small>
                    </div>

                    @if (Model.Height.HasValue && Model.CurrentWeight.HasValue && Model.Height.Value > 0)
                    {
                        var heightInMeters = Model.Height.Value / 100;
                        var bmi = Model.CurrentWeight.Value / (heightInMeters * heightInMeters);
                        
                        string bmiCategory;
                        string bmiClass;
                        
                        if (bmi < 18.5f)
                        {
                            bmiCategory = "Niedowaga";
                            bmiClass = "alert-warning";
                        }
                        else if (bmi < 25f)
                        {
                            bmiCategory = "Waga prawid³owa";
                            bmiClass = "alert-success";
                        }
                        else if (bmi < 30f)
                        {
                            bmiCategory = "Nadwaga";
                            bmiClass = "alert-warning";
                        }
                        else
                        {
                            bmiCategory = "Oty³oœæ";
                            bmiClass = "alert-danger";
                        }

                        <div class="alert @bmiClass mt-3" id="bmiAlert">
                            <strong>Twoje BMI:</strong> <span id="bmiValue">@bmi.ToString("F1")</span> - <span id="bmiCategory">@bmiCategory</span><br />
                            <small>BMI (Body Mass Index) to wskaŸnik masy cia³a obliczany na podstawie wzrostu i wagi</small>
                        </div>
                    }
                </div>
            </div>

            <!-- 2. PREFERENCJE ¯YWIENIOWE -->
            <div class="dashboard-card visible mb-4">
                <div class="card-icon bg-success-light">
                    <i class="bi bi-heart-pulse"></i>
                </div>
                <div class="card-content">
                    <h3>Preferencje ¿ywieniowe</h3>
                    <p class="text-muted mb-3">Wybierz swoj¹ dietê i cele</p>
                    
                    <!-- Dieta -->
                    <div class="form-group">
                        <label for="dietSelect" class="form-label">Wybierz swoj¹ dietê</label>
                        <select class="form-select" id="dietSelect" name="SelectedDietType" asp-for="SelectedDietType">
                            @foreach (var dietType in Model.AvailableDietTypes)
                            {
                                <option value="@dietType">@dietType</option>
                            }
                        </select>
                        <small class="text-muted">Dieta wp³ynie na rekomendacje przepisów</small>
                    </div>

                    <!-- Cel ¿ywieniowy -->
                    <div class="form-group">
                        <label for="NutritionGoal" class="form-label">Cel ¿ywieniowy *</label>
                        <select class="form-select" id="NutritionGoal" name="NutritionGoal" asp-for="NutritionGoal" required>
                            <option value="">-- Wybierz cel --</option>
                            <option value="1">Redukcja wagi (Cut)</option>
                            <option value="0">Utrzymanie wagi (Maintain)</option>
                            <option value="2">Budowa miêœni (Bulk)</option>
                        </select>
                        <span asp-validation-for="NutritionGoal" class="text-danger"></span>
                    </div>

                    <!-- Poziom aktywnoœci -->
                    <div class="form-group">
                        <label for="ActivityLevel" class="form-label">Poziom aktywnoœci *</label>
                        <select class="form-select" id="ActivityLevel" name="ActivityLevel" asp-for="ActivityLevel" required>
                            <option value="">-- Wybierz poziom --</option>
                            <option value="0">Siedz¹cy (brak æwiczeñ)</option>
                            <option value="1">Lekko aktywny (1-3 dni/tydzieñ)</option>
                            <option value="2">Umiarkowanie aktywny (3-5 dni/tydzieñ)</option>
                            <option value="3">Bardzo aktywny (6-7 dni/tydzieñ)</option>
                            <option value="4">Ekstremalnie aktywny (2x dziennie)</option>
                        </select>
                        <span asp-validation-for="ActivityLevel" class="text-danger"></span>
                    </div>

                    <!-- Przycisk oblicz -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-success btn-lg" onclick="calculateNutrition()" id="calculateBtn">
                            <i class="bi bi-calculator"></i> Oblicz cele ¿ywieniowe
                        </button>
                        <small class="d-block text-muted mt-2">
                            Oblicz kalorie i makrosk³adniki na podstawie Twoich danych
                        </small>
                    </div>

                    <!-- Wyniki obliczeñ -->
                    @if (Model.CalculatedCalories.HasValue)
                    {
                        <div class="alert alert-success mt-4" id="calculationResults">
                            <h5><strong>Obliczone cele ¿ywieniowe:</strong></h5>

                            <div class="text-center mt-3">
                                <div class="nutrition-stat d-inline-block">
                                    <div class="stat-value text-primary">@Model.CalculatedCalories</div>
                                    <div class="stat-label">Kalorie/dzieñ</div>
                                </div>
                            </div>

                            <div class="row justify-content-center mt-3">
                                <div class="col-12 col-md-4 text-center mb-3">
                                    <div class="nutrition-stat">
                                        <div class="stat-value">@Model.CalculatedProtein?.ToString("F0")g</div>
                                        <div class="stat-label">Bia³ko</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4 text-center mb-3">
                                    <div class="nutrition-stat">
                                        <div class="stat-value">@Model.CalculatedFat?.ToString("F0")g</div>
                                        <div class="stat-label">T³uszcze</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4 text-center mb-3">
                                    <div class="nutrition-stat">
                                        <div class="stat-value">@Model.CalculatedCarbs?.ToString("F0")g</div>
                                        <div class="stat-label">Wêglowodany</div>
                                    </div>
                                </div>
                            </div>
                            <hr />
                            <small class="text-muted">
                                Makrosk³adniki dostosowane do celu: bia³ko 4kcal/g, t³uszcze 9kcal/g, wêglowodany 4kcal/g
                            </small>
                        </div>

                        <!-- Hidden inputs dla obliczonych wartoœci -->
                        <input type="hidden" name="CalculatedCalories" value="@Model.CalculatedCalories" />
                        <input type="hidden" name="CalculatedProtein" value="@Model.CalculatedProtein" />
                        <input type="hidden" name="CalculatedFat" value="@Model.CalculatedFat" />
                        <input type="hidden" name="CalculatedCarbs" value="@Model.CalculatedCarbs" />
                    }
                </div>
            </div>

            <!-- 3. EMAIL -->
            <div class="dashboard-card visible mb-4">
                <div class="card-icon bg-primary-light">
                    <i class="bi bi-person"></i>
                </div>
                <div class="card-content">
                    <h3>Informacje o koncie</h3>
                    <div class="form-group mt-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" value="@Model.Email" disabled />
                        <small class="text-muted">Email nie mo¿e byæ zmieniony</small>
                    </div>
                </div>
            </div>

            <!-- Przyciski akcji -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-save"></i> Zapisz wszystkie ustawienia
                </button>
                <a asp-controller="Home" asp-action="Index" class="btn btn-secondary btn-lg ms-2">
                    <i class="bi bi-x-circle"></i> Anuluj
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Funkcja do obliczania celów ¿ywieniowych (bez zapisywania)
        function calculateNutrition() {
            const age = document.getElementById('Age').value;
            const height = document.getElementById('Height').value;
            const weight = document.getElementById('CurrentWeight').value;
            const sex = document.getElementById('Sex').value;
            const activityLevel = document.getElementById('ActivityLevel').value;
            const nutritionGoal = document.getElementById('NutritionGoal').value;

            if (!age || !height || !weight || !sex || !activityLevel || !nutritionGoal) {
                alert('Proszê wype³niæ wszystkie wymagane pola przed obliczeniem celów.');
                return;
            }

            // Wy³¹cz przycisk i poka¿ loader
            const btn = document.getElementById('calculateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Obliczanie...';

            // Wyœlij do akcji obliczaj¹cej (GET z parametrami)
            const params = new URLSearchParams({
                'Age': age,
                'Height': height,
                'CurrentWeight': weight,
                'Sex': sex,
                'ActivityLevel': activityLevel,
                'NutritionGoal': nutritionGoal,
                'SelectedDietType': document.getElementById('dietSelect').value || ''
            });

            window.location.href = '@Url.Action("CalculateNutritionPreview", "User")' + '?' + params.toString();
        }

        // Funkcja do aktualizacji wartoœci suwaka
        function updateSliderValue(sliderId, valueSpanId, unit) {
            const slider = document.getElementById(sliderId);
            const valueSpan = document.getElementById(valueSpanId);
            const value = parseFloat(slider.value);
            
            if (sliderId === 'Age') {
                valueSpan.textContent = value.toFixed(0);
            } else {
                valueSpan.textContent = value.toFixed(1);
            }
            
            // Aktualizuj BMI w czasie rzeczywistym
            updateBMI();
        }

        // Funkcja do obliczania i aktualizacji BMI
        function updateBMI() {
            const height = parseFloat(document.getElementById('Height').value);
            const weight = parseFloat(document.getElementById('CurrentWeight').value);
            
            if (height > 0 && weight > 0) {
                const heightInMeters = height / 100;
                const bmi = weight / (heightInMeters * heightInMeters);
                
                let bmiCategory, bmiClass;
                if (bmi < 18.5) {
                    bmiCategory = 'Niedowaga';
                    bmiClass = 'alert-warning';
                } else if (bmi < 25) {
                    bmiCategory = 'Waga prawid³owa';
                    bmiClass = 'alert-success';
                } else if (bmi < 30) {
                    bmiCategory = 'Nadwaga';
                    bmiClass = 'alert-warning';
                } else {
                    bmiCategory = 'Oty³oœæ';
                    bmiClass = 'alert-danger';
                }
                
                // Utwórz lub zaktualizuj alert BMI
                let bmiAlert = document.getElementById('bmiAlert');
                if (!bmiAlert) {
                    bmiAlert = document.createElement('div');
                    bmiAlert.id = 'bmiAlert';
                    bmiAlert.className = 'alert mt-3';
                    bmiAlert.innerHTML = `
                        <strong>Twoje BMI:</strong> <span id="bmiValue"></span> - <span id="bmiCategory"></span><br />
                        <small>BMI (Body Mass Index) to wskaŸnik masy cia³a obliczany na podstawie wzrostu i wagi</small>
                    `;
                    document.querySelector('.dashboard-card:first-child .card-content').appendChild(bmiAlert);
                }
                
                // Zaktualizuj klasê i wartoœci
                bmiAlert.className = 'alert ' + bmiClass + ' mt-3';
                document.getElementById('bmiValue').textContent = bmi.toFixed(1);
                document.getElementById('bmiCategory').textContent = bmiCategory;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const cards = document.querySelectorAll('.dashboard-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('visible');
                }, index * 150);
            });
            
            // Inicjalizuj wartoœci suwaków
            updateSliderValue('Age', 'ageValue', ' lat');
            updateSliderValue('Height', 'heightValue', ' cm');
            updateSliderValue('CurrentWeight', 'weightValue', ' kg');
        });
    </script>
}





